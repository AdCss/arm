---
title: "Chapter 3, Problem 5 (Gelman & Hill)"
author: "Gianluca Rossi"
date: "29 October 2015"
output: html_document
---

The folder `beauty` contains data from Hamermesh and Parker (2005) on student evaluations of instructorsâ€™ beauty and teaching quality for several courses at the University of Texas. The teaching evaluations were conducted at the end of the semester, and the beauty judgments were made later, by six students who had not attended the classes and were not aware of the course evaluations.

```{r load_libraries, message=FALSE}
require(arm)
require(foreign)
```

```{r load_data, cache=TRUE}
beauty <- read.csv("http://www.stat.columbia.edu/~gelman/arm/examples/beauty/ProfEvaltnsBeautyPublic.csv")
head(beauty)
```

### Part a

*Run a regression using beauty (the variable `btystdave`) to predict course evaluations (`courseevaluation`), controlling for various other inputs. Display the fitted model graphically, and explaining the meaning of each of the coefficients, along with the residual standard deviation. Plot the residuals versus fitted values.*

```{r fit_m1}
m1 <- lm(btystdave ~ courseevaluation + female + age, data=beauty)
display(m1)
```

```{r plot_residuals_m1}
par(mfrow=c(2,2))
plot(m1)
```

We fitted a model which tries to explain the variance of the variable `btystdave` using a linear combination of `courseevaluation`, `female` and `age`. The above graphs help us to understand how the residuals are distributed in order to splot unusual behaviours we can leverage to improve our model.

The first and third graph (top-left and bottom-left) show some heteroschedasticity in the residuals, which means the residuals do not have equal variance. In the presence of heteroscedasticity, OLS estimates are unbiased, but the usual tests of significance are generally inappropriate and their use can lead to incorrect inferences. The second plot (top-right) shows that residuals are not perfectly normal, which makes inferences based on this model not reliable. However, the model can still be used to understand how variables interract which each other. From the last plot (bottom-right) we can see there are many residuals which fall far away from 0. This is consistent with the previous observations and suggests that more work should be done to improve our model.

We won't pay excessive attention to coefficient's standard error (and p-values) because of the presence of heteroschedasticity and not normal distributed residuals. Anyway, we can from the model's summary results that `courseevaluation` is  by far the most prominent variable in our model. Students which scored 0.1 points higher have on average 0.27 beauty score. At the same time, female student do generally have a better beauty score; if a student is female, in fact, she will generally have a beauty score 0.12 higher than a male student with same course evaluation and age. The last covariate in our model is `age`. We can notice this has a mildly negative coefficient. With every additional year of age, beauty score tends to decrease by 0.02.

```{r plot_m1}
beta.hat <- coef(m1) 
beta.sim <- sim(m1)@coef
par(mfrow=c(1,3))

# plot course evaluation against beauty score
plot(beauty$courseevaluation, beauty$btystdave, pch=20, xlab="course score", ylab="beauty score")
for (i in 1:10){
  curve (cbind (1, x, mean(beauty$female), mean(beauty$age)) %*% beta.sim[i,], lwd=.5, col="gray", add=TRUE)
}
curve (cbind (1, x, mean(beauty$female), mean(beauty$age)) %*% beta.hat, col="black", add=TRUE)

# plot sex against beauty score
plot(beauty$female, beauty$btystdave, pch=20, xlab="female", ylab="beauty score")
for (i in 1:10){
  curve (cbind (1, mean(beauty$courseevaluation), x, mean(beauty$age)) %*% beta.sim[i,], lwd=.5, col="gray", add=TRUE)
}
curve (cbind (1, mean(beauty$courseevaluation), x, mean(beauty$age)) %*% beta.hat, col="black", add=TRUE)

# plot age against beauty score
plot(beauty$age, beauty$btystdave, pch=20, xlab="age", ylab="beauty score")
for (i in 1:10){
  curve (cbind (1, mean(beauty$courseevaluation), mean(beauty$female), x) %*% beta.sim[i,], lwd=.5, col="gray", add=TRUE)
}
curve (cbind (1, mean(beauty$courseevaluation), mean(beauty$female), x) %*% beta.hat, col="black", add=TRUE)
```

### Part b

*Fit some other models, including beauty and also other input variables. Consider at least one model with interactions. For each model, state what the predictors are, and what the inputs are (see Section 3.7), and explain the meaning of each of its coefficients.*

```{r fit_m2}
m2 <- lm(btystdave ~ courseevaluation * female + age, data=beauty)
display(m2)
```

```{r plot_residuals_m2}
par(mfrow=c(2,2))
plot(m2)
```

`m2` is a particularly interesting model because in addition to `m1` shows the interraction term between the score in the class and sex. From the summary table above we can see all coefficients are significant. In particular it seems that, even though females have generally a beauty score higher than male students with similar characteristics, the higher their score on the class the lower is their beauty score compared to similar male students. 

We will now fit a model which, compared to `m2`, adds a few more input variables. As we will see, this model, although slighly more complicated, will be able to explain better the variance of our outcome variable.

```{r fit_m3}
m3 <- lm(btystdave ~ courseevaluation * female + age + blkandwhite + formal, data=beauty)
display(m3)
```

```{r plot_residuals_m3}
par(mfrow=c(2,2))
plot(m3)
```

This last model looks much better than `m1` and `m2`. To begin with residuals are almost normal and heteroschedasticity, althogh still present, looks less of a concern. The addition of `blkandwhite` and `formal` increased by a significant amount R-squared too; our model now explains about 22% of the beauty score variation. 

Model `m3` includes five inputs: 

* `courseevaluation`: an ordinal numerical variable which represent the score in the class test
* `female`: a binary variable which takes value of 1 when the subject was a female, and 0 when male
* `age`: an ordinal numerical variable to represent the age of the subject on the picture 
* `blkandwhite`: a binary variable which takes value of 1 when the picture is black and white and 0 when it was in colours
* `formal`: a binary variable which takes value of 1 when the subject in the picture was wearing formal clothes, and 0 when it wasn't

In the model we have six predictors:

* `courseevaluation`: the coefficient represents the slope of this variable, among those subjects for whom variables `female`, `age`, `blkandwhite` and `formal` equal to 0
* `female`: the coefficient represents the predicted difference for subjects that differ in sex, among those with `courseevaluation`, `age`, `blkandwhite` and `formal` equal to 0
* `age`: the coefficient represents the slope of this variable, among those subjects for whom variables `courseevaluation`, `female`, `blkandwhite` and `formal` equal to 0
* `blkandwhite`: the coefficient represents the predicted difference for subjects that differ in picture colour, among those with `courseevaluation`, `female`, `age` and `formal` equal to 0
* `formal`: the coefficient represents the predicted difference for subjects that differ in clothing type, among those with `courseevaluation`, sex, `age` and `blkandwhite` equal to 0
* `courseevaluation:female`: the coefficient on the interaction term represents the difference in the slope, comparing subjects that are females to those that are males

```{r plot_m3, echo=FALSE}
beta.hat <- coef(m3) 
beta.sim <- sim(m3)@coef
par(mfrow=c(2,3))

colours=ifelse(beauty$female==1, "#fa9fb5", "#9ecae1")

# plot course evaluation against beauty score
plot(beauty$courseevaluation, beauty$btystdave, pch=20, xlab="course score", ylab="beauty score", col=colours)
for (i in 1:10) {
  curve(cbind(1, x, 1, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.sim[i,], lwd=.5, col="#fde0dd", add=TRUE)
}
curve(cbind(1, x, 1, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.hat, col="red", add=TRUE)

for (i in 1:10) {
  curve(cbind(1, x, 0, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.sim[i,], lwd=.5, col="lightblue", add=TRUE)
}
curve(cbind(1, x, 0, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.hat, col="blue", add=TRUE)
       

# plot sex against beauty score
plot(beauty$female, beauty$btystdave, pch=20, xlab="sex (male = 0, female = 1)", ylab="beauty score", col=colours)
for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), x, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.sim[i,], lwd=.5, col="#fde0dd", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), x, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.hat, col="red", add=TRUE)

for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), x, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.sim[i,], lwd=.5, col="lightblue", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), x, mean(beauty$age), mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.hat, col="blue", add=TRUE)


# plot age against beauty score
plot(beauty$age, beauty$btystdave, pch=20, xlab="age", ylab="beauty score", col=colours)
for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 1, x, mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.sim[i,], lwd=.5, col="#fde0dd", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 1, x, mean(beauty$blkandwhite), mean(beauty$formal), 1 * x) %*% beta.hat, col="red", add=TRUE)

for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 0, x, mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.sim[i,], lwd=.5, col="lightblue", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 0, x, mean(beauty$blkandwhite), mean(beauty$formal), 0 * x) %*% beta.hat, col="blue", add=TRUE)


# plot type of picture against beauty score
plot(beauty$blkandwhite, beauty$btystdave, pch=20, xlab="colours (colour = 0, black and white = 1)", ylab="beauty score", col=colours)
for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 1, mean(beauty$age), x, mean(beauty$formal), 1 * x) %*% beta.sim[i,], lwd=.5, col="#fde0dd", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 1, mean(beauty$age), x, mean(beauty$formal), 1 * x) %*% beta.hat, col="red", add=TRUE)

for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 0, mean(beauty$age), x, mean(beauty$formal), 0 * x) %*% beta.sim[i,], lwd=.5, col="lightblue", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 0, mean(beauty$age), x, mean(beauty$formal), 0 * x) %*% beta.hat, col="blue", add=TRUE)


# plot dressing code against beauty score
plot(beauty$formal, beauty$btystdave, pch=20, xlab="dressing code (casual = 0, formal = 1)", ylab="beauty score", col=colours)
for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 1, mean(beauty$age), mean(beauty$blkandwhite), x, 1 * x) %*% beta.sim[i,], lwd=.5, col="#fde0dd", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 1, mean(beauty$age), mean(beauty$blkandwhite), x, 1 * x) %*% beta.hat, col="red", add=TRUE)

for (i in 1:10) {
  curve(cbind(1, mean(beauty$courseevaluation), 0, mean(beauty$age), mean(beauty$blkandwhite), x, 0 * x) %*% beta.sim[i,], lwd=.5, col="lightblue", add=TRUE)
}
curve(cbind(1, mean(beauty$courseevaluation), 0, mean(beauty$age), mean(beauty$blkandwhite), x, 0 * x) %*% beta.hat, col="blue", add=TRUE)
```